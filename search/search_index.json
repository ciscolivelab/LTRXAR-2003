{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#ltrxar-2003","title":"LTRXAR - 2003","text":"<p>Welcome to Cisco Live LTRXAR-2003 - SD-WAN Multi-Region Fabric(MRF) Migration Lab</p> <p>For full documentation visit Cisco Live.</p>"},{"location":"#speakers","title":"Speakers","text":"<ul> <li>Lei Tian <code>Customer Delivery Architect, Cisco CX</code></li> <li>Oscar Eduardo Desentis Clemente <code>Customer Delivery Architect, Cisco CX</code></li> </ul>"},{"location":"about/","title":"About The Lab","text":""},{"location":"about/#multi-region-fabric-mrf-overview","title":"Multi-Region Fabric (MRF) Overview","text":"<p>The current Catalyst SDWAN architecture follows a flat overlay model, establishing site-to-site tunnels directly between sites. While this flat overlay model functions adequately in many scenarios, it does have its limitations:  </p> <ul> <li>Centralized control policy is necessary for Hub and Spoke topology or setting route preferences. Depending on the specific requirements of the topology, this policy can become quite complex.  </li> <li>Integrating transports from disparate providers for the underlay can be challenging. This is particularly relevant when attempting to leverage middle mile providers or cloud backbone providers' networks for inter-region traffic.  </li> <li>Large enterprises and managed service providers (MSPs) often require SDWAN to extend across multiple regions.  </li> </ul> <p>Now, with Multi-Region Fabric (MRF), it offers following enhancements  </p> <ul> <li>Foundational capability that underpins our journey to multi-cloud and SDCI  <ul> <li>Ensure market-leading scalability  </li> <li>Service enablement at gateway points</li> <li>Increase network resiliency  </li> </ul> </li> <li>Improve OMP to support a true scalable Multi-Region Fabric SD-WAN  </li> <li>3-level customer overlay  <ul> <li>Introduces Regions  </li> <li>Primary Access Region  </li> <li>Secondary Region  </li> <li>Subregion  </li> <li>Border routers provide tunnel stitching  </li> <li>Inter Regions always goes via border routers  </li> </ul> </li> <li>End to end SLA aware path computation  </li> <li>Simplifies user-visible configuration  </li> </ul>"},{"location":"about/#about-this-lab","title":"About This Lab","text":"<p>This lab has been designed to showcase a comprehensive array of MRF features provided by the Cisco SD-WAN solution in a systematic manner. While a predefined topology is outlined and associated with each scenario, the lab instructions can also be tailored to the specific requirements of attendees. Participants can utilize the steps outlined in this lab to transition their flat fabric into an MRF.  </p> <p>Upon completing this lab, you will:  </p> <ul> <li>Gain insight into the intricacies of using the legacy approach to create and deploy hierarchical topologies within a flat Catalyst SD-WAN Fabric.  </li> <li>Successfully migrate from a flat Catalyst SD-WAN fabric to an MRF fabric with minimal disruption.  </li> <li>Understand the streamlined process for deploying a hierarchical topology using MRF fabric.  </li> <li>Understand and deploy MRF features such as 2nd region, transit gateway and MRF policy.  </li> </ul>"},{"location":"access/","title":"Lab Crendential","text":"<p>Below table provides the IP addresses and credentials for the devices used in this lab:  </p> <ul> <li>UI Connection Details</li> </ul> Node IP:Port Username Password Manager https://vmanage.dcloud.cisco.com:8443 admin C1sco12345 <ul> <li>SD-WAN Controllers</li> </ul> Hostname System IP Site ID Username Password Manager-1 1.1.1.1 1 admin C1sco12345 Validator-1 1.1.1.2 1 admin C1sco12345 Controller-1 1.1.1.3 1 admin C1sco12345 Controller-2 1.1.1.4 1 admin C1sco12345 Controller-3 1.1.1.5 1 admin C1sco12345 Controller-4 1.1.1.6 1 admin C1sco12345 <ul> <li>SD-WAN Edges</li> </ul> Hostname System IP Site ID Username Password BR-WEST-1 1.1.201.1 201 admin C1sco12345 BR-WEST-2 1.1.201.2 201 admin C1sco12345 BR-EAST-1 1.1.202.1 202 admin C1sco12345 BR-EAST-2 1.1.202.2 202 admin C1sco12345 EDGE-HUB-1-01 1.1.10.1 1010 admin C1sco12345 EDGE-HUB-1-02 1.1.10.2 1010 admin C1sco12345 EDGE-HUB-2-01 1.1.20.1 1020 admin C1sco12345 EDGE-HUB-2-02 1.1.20.2 1020 admin C1sco12345 EDGE-BRANCH-3-01 1.1.30.1 3000 admin C1sco12345 EDGE-BRANCH-4-01 1.1.40.1 4000 admin C1sco12345 EDGE-BRANCH-4-02 1.1.40.2 4000 admin C1sco12345 EDGE-BRANCH-5-01 1.1.50.1 5000 admin C1sco12345 EDGE-BRANCH-6-01 1.1.60.1 6000 admin C1sco12345 EDGE-BRANCH-7-01 1.1.70.1 7000 admin C1sco12345 <ul> <li>SD-WAN Edges - Interfaces  </li> </ul> Hostname Pub-Inet TLOC If Pub-Inet IP Address MPLS TLOC If MPLS IP Address Private1 TLOC If Private1 IP Address Private2 TLOC If Private2 IP Address BR-WEST-1 Gi2 124.124.124.2/24 Gi1 10.2.1.2/24 Gi3 172.16.1.1/24 Gi4 172.16.2.1/24 BR-WEST-2 Gi2 125.125.125.2/24 Gi1 10.2.2.2/24 Gi3 172.16.1.2/24 Gi4 172.16.2.2/24 BR-EAST-1 Gi2 131.131.131/2/24 Gi1 10.2.3.1/24 Gi3 172.16.1.3/24 Gi4 172.16.2.3/24 BR-EAST-2 Gi2 132.132.132.2/24 Gi1 10.2.4.1/24 Gi3 172.16.1.4/24 Gi4 172.16.2.4/24 Hostname Pub-Inet TLOC If Pub-Inet IP Address MPLS TLOC If MPLS IP Address SVPN 10 If SVPN 10 IP Address SVPN 11 If SVPN 11 IP Address EDGE-DC-1-01 Gi1 126.126.126.2/24 Gi2 10.2.5.1/24 Gi3 10.10.1.1/24 Gi4 10.11.1.1/24 EDGE-DC-1-02 Gi1 128.128.128.2/24 Gi2 10.2.6.2/24 Gi3 10.10.1.2/24 Gi4 10.11.1.2/24 EDGE-DC-2-01 Gi1 129.129.129.2/24 Gi2 10.2.7.2/24 Gi3 10.20.1.1/24 Gi4 10.21.1.1/24 EDGE-DC-2-02 Gi1 130.130.130.2/24 Gi2 10.2.8.2/24 Gi3 10.20.1.2/24 Gi4 10.21.1.2/24 EDGE-BRANCH-3-01 Gi1 133.133.133.2/24 Gi2 10.2.9.2/24 Gi3 10.30.1.1/24 Gi4 10.31.1.1/24 EDGE-BRANCH-4-01 Gi1 144.144.144.2/24 Gi2 10.2.10.130/25 Gi3 10.40.1.1/24 Gi4 10.41.1.1/24 EDGE-BRANCH-4-02 Gi1 192.168.0.2/24 Gi2 10.2.10.2/25 Gi3 10.40.1.2/24 Gi4 10.41.1.2/24 EDGE-BRANCH-5-01 Gi1 145.145.145.2/24 Gi2 10.2.11.2/24 Gi3 10.50.1.129/25 Gi4 10.51.1.129/25 EDGE-BRANCH-6-01 Gi1 146.146.146.2/24 N/A N/A Gi2 10.60.1.1/24 Gi3 10.61.1.1/24 EDGE-BRANCH-7-01 N/A N/A Gi1 10.2.12.2/24 Gi2 10.70.1.129/25 Gi3 10.71.1.129/25"},{"location":"login/","title":"Pod Login","text":"<p>You will initiate VPN connection to the network setup used in this lab.  All the devices in this lab are running as Virtual Instances.  At the end of this task, you will have VPN connection to this remote setup</p>"},{"location":"login/#step-1-connect-to-lab-using-anyconnect-vpn","title":"Step 1: Connect to lab using anyconnect VPN","text":"<p>You will connect to Anyconnect url using Cisco VPN AnyConnect client and with the username &amp; password as documented in below table.  Below screenshot shows an example of that VPN connection.</p> Pod ID Attendee Name Anyconnect url Anyconnect Username Anyconnect Password POD  1 dcloud-sjc-anyconnect.cisco.com POD  2 dcloud-sjc-anyconnect.cisco.com POD  3 dcloud-sjc-anyconnect.cisco.com POD  4 dcloud-sjc-anyconnect.cisco.com POD  5 dcloud-sjc-anyconnect.cisco.com POD  6 dcloud-sjc-anyconnect.cisco.com POD  7 dcloud-sjc-anyconnect.cisco.com POD  8 dcloud-sjc-anyconnect.cisco.com POD  9 dcloud-sjc-anyconnect.cisco.com POD  10 dcloud-sjc-anyconnect.cisco.com POD  11 dcloud-sjc-anyconnect.cisco.com POD  12 dcloud-sjc-anyconnect.cisco.com POD  13 dcloud-sjc-anyconnect.cisco.com POD  14 dcloud-sjc-anyconnect.cisco.com POD  15 dcloud-sjc-anyconnect.cisco.com POD  16 dcloud-sjc-anyconnect.cisco.com POD  17 dcloud-sjc-anyconnect.cisco.com POD  18 dcloud-sjc-anyconnect.cisco.com <p>Note</p> <p>Please use the dcloud login associated with your name.  If you can't find your name in the table please ask the lab speakers.</p> <p></p>"},{"location":"login/#step-2-enter-vpn-credentials","title":"Step 2: Enter VPN credentials","text":"<p>After prompted for credentials, use the credentials documented in above table or provided by the lab admin.</p> <ul> <li>Below is an example of user logging into a reference POD:</li> </ul> <p></p> <ul> <li>Hit accept when the prompt appears to accept the VPN connection login</li> </ul> <p></p>"},{"location":"login/#step-3-rdp-to-workstation","title":"Step 3: RDP to workstation","text":"<p>In this step, you will connect to the workstation with Remote Desktop (RDP) client on your machines.  Use below details for this RDP session:</p> <ul> <li>Workstation: 198.18.133.36</li> <li>Username: admin</li> <li>Password: C1sco12345</li> </ul> <p>Below screenshot is only an example for this RDP connection:</p> <p></p>"},{"location":"task1/","title":"Task 1 - Explore Flat Fabric Policy","text":"<p>In this task you will understand the current active centralized policy that creates a Regional Hub &amp; Spoke topology.  </p>"},{"location":"task1/#step-1-review-existing-policy","title":"Step 1: Review existing policy","text":"<p>Once you have the RDP session to the remote workstation, open Chrome browser icon on the desktop.  </p> <ul> <li> <p>Enter https://vmanage.dcloud.cisco.com:8443 in browser address bar; login with username admin, password C1sco12345.  </p> </li> <li> <p>Click SD-WAN Manager navagination bar, go to Configuration &gt; Policies. Locate pre-configured policy REGIONAL_HUB_AND_SPOKE_BGP_CORE_POLICY, click the ... on the right and select Preview.  </p> </li> </ul> <p></p> <ul> <li>This REGIONAL_HUB_AND_SPOKE_BGP_CORE_POLICY policy adjusts the Control Plane to intercommunicate all sites within the West region in a full-mesh fashion but without direct connectivity to the East region, by denying TLOCs and using TLOC re-writes. For this we rely on the West Hub (Site 201) connectivity towards the East Hub (Site 202) through the BGP Core network using Service side VPN.  </li> </ul> <p>Note</p> <p>Refer to the Regional Hub &amp; Spoke with BGP Core topology diagram for further analysis.</p> <ul> <li>As you can see it is a complex policy even for a very small environment with same two transports used everywhere.  </li> </ul> <pre><code>viptela-policy:policy\n control-policy EAST-BRANCHES-SITES-CP\n    sequence 1\n     match tloc\n      site-list EAST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list EAST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n    sequence 21\n     match route\n      site-list WEST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n      set\n       tloc-list EAST-HUB-TLOCS\n      !\n     !\n    !\n  default-action reject\n !\n control-policy BGP-CORE-EAST-HUB-CP\n    sequence 1\n     match tloc\n      site-list EAST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list EAST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n  default-action reject\n !\n control-policy BGP-CORE-WEST-HUB-CP\n    sequence 1\n     match tloc\n      site-list WEST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list WEST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n  default-action reject\n !\n control-policy WEST-BRANCHES-SITES-CP\n    sequence 1\n     match tloc\n      site-list WEST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list WEST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n    sequence 21\n     match route\n      site-list EAST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n      set\n       tloc-list WEST-HUB-TLOCS\n      !\n     !\n    !\n  default-action reject\n !\n lists\n  site-list EAST-ALL-SITES\n   site-id 202 \n   site-id 6000-7000 \n  !\n  site-list EAST-BRANCHES\n   site-id 6000 \n   site-id 7000 \n  !\n  site-list EAST-HUB\n   site-id 202 \n  !\n  site-list WEST-ALL-SITES\n   site-id 201 \n   site-id 1010-1020 \n   site-id 3000-5000 \n  !\n  site-list WEST-BRANCHES\n   site-id 1010-1020 \n   site-id 3000 \n   site-id 4000 \n   site-id 5000 \n  !\n  site-list WEST-HUB\n   site-id 201 \n  !\n  tloc-list EAST-HUB-TLOCS\n   tloc 1.1.202.1 color public-internet encap ipsec \n   tloc 1.1.202.1 color mpls encap ipsec \n   tloc 1.1.202.2 color public-internet encap ipsec \n   tloc 1.1.202.2 color mpls encap ipsec \n  !\n  tloc-list WEST-HUB-TLOCS\n   tloc 1.1.201.1 color public-internet encap ipsec \n   tloc 1.1.201.1 color mpls encap ipsec \n   tloc 1.1.201.2 color public-internet encap ipsec \n   tloc 1.1.201.2 color mpls encap ipsec \n  !\n  prefix-list _AnyIpv4PrefixList\n   ip-prefix 0.0.0.0/0 le 32 \n  !\n !\n!\napply-policy\n site-list WEST-BRANCHES\n  control-policy WEST-BRANCHES-SITES-CP out\n !\n site-list EAST-BRANCHES\n  control-policy EAST-BRANCHES-SITES-CP out\n !\n site-list EAST-HUB\n  control-policy BGP-CORE-EAST-HUB-CP out\n !\n site-list WEST-HUB\n  control-policy BGP-CORE-WEST-HUB-CP out\n !\n!\n</code></pre>"},{"location":"task1/#step-2-review-bfd-tunnels","title":"Step 2: Review BFD Tunnels","text":"<p>Next, you'll examine the BFD tunnels from the spoke sites. You can either utilize the Manager Real Time UI option to confirm TLOCs and BFD sessions, or opt to SSH into the WAN Edges and execute command lines via an SSH terminal. For SSH access, you can leverage mRemoteNG on your desktop.  </p> <ul> <li> <p>From the SD-WAN Manager navagination bar, click Monitor &gt; Device. Locate EDGE-BRANCH-3-01, click on the device and choose Real Time as shown in the screenshot below.  </p> </li> <li> <p>In the Device Options field, enter OMP Received TLOCS. As you can see, there are no TLOCs to any site in the East region and therefore no tunnels to any sites in the East region either.  </p> </li> </ul> <p> </p> <ul> <li>We can confirm this by looking for BFD Sessions in the Device Options field.  </li> </ul> <p>We don\u2019t see East TLOC\u2019s IPs like 1.1.60.1, 1.1.70.1, 1.1.202.1 or 1.1.202.2 nor BFD tunnels against their Site IDs 202,6000 and 7000 </p> <p> </p>"},{"location":"task1/#step-3-review-ip-route","title":"Step 3: Review IP Route","text":"<p>Next, you'll examine the route tables from the spoke sites.  </p> <ul> <li>In the Device Options field, enter IP route.  </li> <li>As you can see, even though it doesn't have tunnels towards the East sites, it has prefixes for such sites but pointing to the West Hubs (Site 201) TLOCs IPs instead of the originators.  </li> </ul> <p> </p>"},{"location":"task1/#step-4-review-path-between-spoke-sites","title":"Step 4: Review Path between spoke sites","text":"<p>Next, you'll run traceroute and ping to test reachability of ubuntu hosts between different branch sites.  </p> <ul> <li>Click mRemoteNG  on your desktop, select Site-3000-VPN-10-Ubun and open RDP session to the host with password C1sco12345. Run ping and traceroute to Ubuntu host in Site 6000 with IP 10.60.1.101.   </li> </ul> <p> </p> <ul> <li> <p>From the trace above, even though site 3000 and site 6000 have the Public-Internet transport in common, they do not communicate directly to each other. That is because the active Control Policy forces traffic going through the Hubs and then the BGP Core as highlighted in red in the trace.  </p> </li> <li> <p>Next, let's check the route table on West hub site BR-WEST-1. Go to the Manager GUI and then go to Monitor &gt; Devices &gt; BR-WEST-1 (1.1.201.1) &gt; Real Time and look up for IP route with the VPN 10 filter.  </p> </li> </ul> <p> </p> <ul> <li>As you see from the route table, the prefixes from East Regions are learned from BGP core. </li> </ul>"},{"location":"task2/","title":"Task 2 - Prepare MRF Migration","text":"<p>In this task, you will perform the following prerequisites before migrating MRF.  </p> <ul> <li>Enable MRF  </li> <li>Creat regions  </li> <li>Provision Controllers for regions  </li> </ul>"},{"location":"task2/#step-1-enable-mrf","title":"Step 1: Enable MRF","text":"<p>In this step, you will enable MRF on vManage.  </p> <p>Info</p> <p>The MRF feature has been pre-enabled for this lab. This section is for your review of the workflow </p> <ul> <li>Click SD-WAN Manager navagination bar, go to Administration &gt; Settings. and confirm that the Multi-Region Fabric setting is enabled (By default is disabled).  </li> </ul> <p></p>"},{"location":"task2/#step-2-create-regions","title":"Step 2: Create Regions","text":"<p>After enabling MRF, the subsequent step involves creating the regions. For this lab, we'll establish two regions: EAST-REGION and WEST-REGION. Upon creation, the system automatically assigns a Region ID. In this lab, WEST-REGION has been assigned with Region ID 1, and EAST-REGION has been assigned Region ID 2.  </p> <p>Info</p> <p>The Regioins has been pre-enabled for this lab. This section is for your review of the workflow  </p> <ul> <li>Go to Configuration &gt; Network Hierarchy and you should see that the EAST-REGION and WEST-REGION have been pre-configured.  </li> </ul> <p></p>"},{"location":"task2/#step-3-provision-controllers-for-regions","title":"Step 3: Provision Controllers for Regions","text":"<p>In MRF, vSmart controller is assigned to specific region. Based on the size of the deployment, the vSmart controller can be dedicated for a region or for a group of regions. For this lab, you will have controllers assigned as shown below:  </p> <ul> <li>Controller-1 (1.1.1.3) as dedicated Controller for WEST-REGION (1).  </li> <li>Controller-2 (1.1.1.4) as dedicated Controller for EAST-REGION (2).  </li> <li>Controller-3 (1.1.1.5) as dedicated Controller for the Core Region (0).  </li> <li>Controller-4 (1.1.1.6) is the default/flat existing Controller serving the whole overlay.  </li> </ul> <p>Info</p> <p>The controllers have been pre-configured for this lab. This section is for your review of the workflow</p> <ul> <li> <p>In this lab, the controller is assigned to the region by configuring Region ID List on controller System feature template. </p> </li> <li> <p>Go to Configuration &gt; Template &gt; Feature Templates, type SYSTEM_FT in the seach field, and you will see 4 pre-configured Controllers feature templates, one for each controller.  </p> </li> </ul> <p></p> <ul> <li> <p>Click the Devices Attached of each controller system ft, you will see the controllers are attached to the feature templates as planned.  </p> <ul> <li>CONTROLLER-1_SYSTEM_FT for Controller-1 (1.1.1.3)  </li> <li>CONTROLLER-2_SYSTEM_FT for Controller-1 (1.1.1.4)  </li> <li>CONTROLLER-3_SYSTEM_FT for Controller-1 (1.1.1.5)  </li> <li>CONTROLLER-4_SYSTEM_FT for Controller-1 (1.1.1.6)  </li> </ul> </li> <li> <p>Click the ... to view each of the controller system feature template.  </p> </li> </ul> <p> </p> <p> </p> <p> </p> <p> </p> <ul> <li> <p>After assigning distributed controllers for regions, all WAN Edges in the overlay have not been assigned to a region, leaving **Controller-4(1.1.1.6) as the default controller for the entire overlay. You can verify that by checking the controller control connections of all WAN Edges.  </p> </li> <li> <p>Go to Monitor &gt; Devices and look the vSmart Control column.  </p> </li> </ul> <p> </p> <p>Note</p> <p>Your output may display 0 control connection. It is cosmatic UI issue, you can confirm the number of connections by click the Edge and check Control Connections from Monitor - Devices view.  </p> <ul> <li>You can also verify this by going to Monitor &gt; Devices; select a device and then look up for OMP peers with the Real Time function.  </li> </ul> <p>For instance, EDGE-BRANCH-3-01 shows only one OMP peer with Controller-4 showing Region ID as None.  </p> <p> </p>"},{"location":"task3/","title":"Task 3 - Enable Migration Mode on Edge Routers","text":"<p>In this task you are going to enable Migration Mode on all Edge devices.</p>"},{"location":"task3/#step-1-create-new-systen-feature-template-for-west-edge-devices","title":"Step 1: Create new Systen Feature Template for West Edge Devices","text":"<p>Go to Configuration &gt; Templates &gt; Feature templates &gt; Add Template, select C8000v and Cisco System.</p> <p></p> <p>Name it as cEDGE_EDGE-WEST_SYSTEM_FT and define only the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Role: Edge Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.</p> <p></p>"},{"location":"task3/#step-2-assign-feature-template-to-west-edge-devices","title":"Step 2: Assign Feature Template to West Edge Devices","text":"<p>Assign the previous created System Feature template named cEDGE_EDGE-WEST_SYSTEM_FT to all West sites and therefore to their proper Device Templates, being:</p> <ul> <li>cEDGE_DC_DT </li> <li>cEDGE_SITE-3000_DT</li> <li>cEDGE_SITE-4000_DT</li> <li>cEDGE_SITE-5000_DT</li> </ul> <p></p> <p>For simplicity let\u2019s do it only for the cEDGE_DC_DT Device Template, however as mentioned you need to repeat it for all other West Sites mentioned above, so click on the 3 dots and then \u2018edit\u2019.</p> <p></p> <p>Next in \u2018Cisco System\u2019 select the cEDGE_EDGE-WEST_SYSTEM_FT.</p> <p></p> <p>Then click \u2018Update\u2019 and you should see the next screen with all 4 DC devices with a little green checkmark.</p> <p></p> <p>Now, click \u2018Next\u2019 and should see the next configuration being applied to all 4 DC devices. </p> <p></p> <p>Finally click \u2018Configure Devices\u2019 to push the new configuration.</p> <p>Note</p> <p>Apply the same new feature template to cEDGE_SITE-3000_DT, cEDGE_SITE-4000_DT and cEDGE_SITE-5000_DT.</p>"},{"location":"task3/#step-3-validate-defaultflat-controller","title":"Step 3: Validate default/flat Controller","text":"<p>Now in Manager UI, go to Monitor &gt; Devices &gt; EDGE-BRANCH-3-01 &gt; Real Time and look up for OMP Peers in the search bar.</p> <p>As you can see the EDGE-BRANCH-3-01 has just 1 OMP peer, one with Controller-4 (1.1.1.6) that serves as default/flat Controller for the whole overlay. Pay special attention to the Region ID as \u2018None\u2019, as this will change in Task 7.</p> <p></p>"},{"location":"task3/#step-4-create-new-systen-feature-template-for-east-edge-devices","title":"Step 4: Create new Systen Feature Template for East Edge Devices","text":"<p>Go to Configuration &gt; Templates &gt; Feature templates &gt; Add Template, select C8000v and Cisco System.</p> <p></p> <p>Name it as cEDGE_EDGE-EAST_SYSTEM_FT and define only the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Role: Edge Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> <p> </p> <p>Click 'Save'.</p> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.</p>"},{"location":"task3/#step-5-assign-feature-template-to-east-edge-devices","title":"Step 5: Assign Feature Template to East Edge Devices","text":"<p>Assign the previous created System Feature template named cEDGE_EDGE-WEST_SYSTEM_FT to all West sites and therefore to their proper Device Templates, being:</p> <ul> <li>cEDGE_SITE-6000_DT </li> <li>cEDGE_SITE-7000_DT</li> </ul> <p></p> <p>For simplicity let\u2019s do it only for the cEDGE_SITE-6000_DT Device Template, however as mentioned you need to repeat it for all other WEST Sites mentioned above, so click on the 3 dots and then \u2018edit\u2019.</p> <p></p> <p>Next in Cisco System select the cEDGE_EDGE-EAST_SYSTEM_FT</p> <p></p> <p>Now, click \u2018Next\u2019 and should see the next configuration being applied to the EDGE-BRANCH-6-01 (1.1.60.1). Finally click \u2018Configure Devices\u2019 to push the new configuration.</p> <p></p> <p>Note</p> <p>Apply the same new feature template to cEDGE_SITE-7000_DT.</p>"},{"location":"task4/","title":"Task 4 - Configure MRF on Border Routers","text":"<p>In this task you will apply BGP Migration Community and MRF on Border Routers.</p> <p>This BGP Community is needed to avoid routing domain loops with the OMP prefixes on the Default/flat Controller being redistributed into the BGP Core and then re-originated and redistributed back again, but now to the Region-aware Controller as shown in the next Diagram. </p> <p>This is because Region-aware OMP routes are preferred over default region OMP routes. </p> <p>Note</p> <p>The BGP Community we will be using is 12 in an additive manner on all Border Routers and PE routers. The same community will be used for the for the OMP to BGP redistribution.  </p> <p></p>"},{"location":"task4/#step-1-enable-draft-mode-on-all-border-routers","title":"Step 1: Enable \"Draft Mode\" on all Border Routers","text":"<p>Because this task requires multiple feature templates changes on the Border routers, we are going to enable \u201cDraft Mode\u201d on all Border routers on Site 201 and 202. This will diminish the impact of the change, otherwise it may cause a mayor disruption.</p> <p>Having said that, go to Configuration &gt; Templates and enable \u201cDraft Mode\u201d on both cEDGE_SITE-201_DT and EDGE_SITE-202_DT device templates as follows.</p> <p></p> <p></p>"},{"location":"task4/#step-2-apply-bgp-migration-community","title":"Step 2: Apply BGP Migration Community","text":"<p>Go to Configuration &gt; Templates &gt; Feature Templates, look up for the cEDGE_HUB_VPN-10_BGP_FT feature template and edit it.</p> <p></p> <p>First, make \u2018Propagate Community\u2019 Global on as shown below.</p> <p></p> <p>Next, go to \u2018Unicast Address Family\u2019 and click on the little pencil to edit the OMP redistribution</p> <p></p> <p>Add MATCH-MIG-COMM as the Route Policy.</p> <p></p> <p>Click 'Save Changes'.</p> <p>Now go to the \u2018Neighbor\u2019 section and click on the little pencil icon to edit it.</p> <p></p> <p>Then make \u2018Route Policy Out\u2019 Global on and in the \u2018Policy Name\u2019 field paste the route policy APPEND-MIG-COMM that was pre-configured on the localized policy for simplicity.</p> <p></p> <p>Finally, click \u2018Save Changes\u2019, \u2018Update\u2019 then \u2018Next\u2019 and then \u2018Configure Devices\u2019 to generate the draft configurations for all East and West border routers.</p> <p></p> <p>You must see these status and messages for the draft configuration generated for all 4 devices.</p> <p></p>"},{"location":"task4/#step-3-configure-mrf-on-west-border-routers","title":"Step 3: Configure MRF on WEST Border Routers","text":"<p>Go to Configuration &gt; Templates &gt; Feature and create a new C8000v \u2018Cisco System\u2019 feature template and name it cEDGE_BORDER-WEST-201_SYSTEM_FT</p> <p></p> <p>Define all the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Region: West-Region</li> <li>Role: Border Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable from BGP Core</li> <li>Migration BGP Community: 12</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.  </p> <p></p> <p></p> <p>Click \u2018Save\u2019.</p> <p>In Device Templates look up for the cEDGE_SITE-201_DT device template and click on edit</p> <p></p> <p>In the \u2018System\u2019 section now select the cEDGE_BORDER-WEST-201_SYSTEM_FT we previously created, then click \u2018update\u2019 and push the change. This will configure BR-WEST-1 and BR-WEST-2 as the border routers role facing the WEST-REGION.</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019 and confirm in the \u2018Config Diff\u2019 section that now both west hubs are assigned to WEST-REGION (1), acting as Border Routers and with the migration mode enabled-from-bgp-core. Finally click \u2018Configure Devices\u2019 to push the changes.</p> <p></p> <p>Again, because the cEDGE_SITE-201_DT device template is still in draft mode, it won\u2019t make any change until we disable draft mode.</p>"},{"location":"task4/#step-4-configure-mrf-on-east-border-routers","title":"Step 4: Configure MRF on EAST Border Routers","text":"<p>Now, let\u2019s repeat the same process but now for the East Border routers. Therefore, go to Configuration &gt; Templates &gt; Feature and create a new C8000v \u2018Cisco System\u2019 feature template and name it cEDGE_BORDER-EAST-202_SYSTEM_FT.</p> <p></p> <p>Define all the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Region: East-Region</li> <li>Role: Border Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable from BGP Core</li> <li>Migration BGP Community: 12</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.  </p> <p></p> <p></p> <p>In Device Templates look up for the cEDGE_SITE-202_DT device template and click on \u2018edit\u2019</p> <p></p> <p>In the \u2018System\u2019 section now select the cEDGE_BORDER-EAST-202_SYSTEM_FT we previously created. This will configure BR-EAST-1 and BR-EAST-2 as the border routers role facing the EAST-REGION.</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019 and confirm in the \u2018Config Diff\u2019 section that now both East hubs are assigned to EAST-REGION (2), acting as Border Routers and with the migration mode enabled-from-bgp-core. Finally click \u2018Configure Devices\u2019 to push the changes.</p> <p></p> <p>Again, because the cEDGE_SITE-202_DT device template is still in draft mode, it won\u2019t make any until we disable draft mode.</p> <p>Now, enable the Private1 TLOC as Core transport for all Border devices,  therefore go to Configuration &gt; Templates &gt; Feature and look up for the feature template cEDGE_SITE-20X_VPN-0_PRIVATE1_CHILD-IF_FT that is shared by all Border devices, and edit it.</p> <p></p> <p>Next, under the \u2018Tunnel\u2019 section, scroll down and under \u2018advance options\u2019 make Global on  the \u2018Enable Core Region\u2019 parameter.</p> <p></p> <p>Then, click \u2018Update\u2019, \u2018Next\u2019 and \u2018Configure Devices\u2019. By doing this, we have enabled the Private1 Core TLOCs to service the Core Region.</p> <p></p> <p>Finally click \u2018Configure Devices\u2019, and again, because all Border routers are in \u201cDraft Mode\u201d, it won\u2019t make any change until we disable draft mode.</p>"},{"location":"task4/#step-5-disable-draft-mode-and-modify-control-policy","title":"Step 5: Disable \u201cDraft Mode\u201d and Modify Control Policy","text":"<p>Go to Configuration &gt; Templates and click \u2018Disable Draft Mode\u201d on both cEDGE_SITE-201_DT and EDGE_SITE-202_DT to push all previous configs we have done on from step 1 to 4, as follows.</p> <p></p> <p>Then click \u2018Disable\u201d on the pop-up window, then \u2018Next\u2019 and finally click \u2018Configure Devices\u2019 to push all changes</p> <p>Note</p> <p>This change will cause a minor churn in the network, therefore try to disable \u201cDraft Mode\u201d as fast as possible on both device templates to diminish the impact.</p> <p>Info</p> <p>You can look at the packet loss % on the  Ubuntu Site-3000-VPN-10-Ubun host in Site 3000 using the RDP  with the mRemoteNG client and the ping and trace we left running since task 1 to the IP 10.60.1.101</p> <p>Repeat the exact same process but not for EDGE_SITE-202_DT.</p> <p>Now go to Monitor &gt; Devices &gt; BR-WEST-1 &gt; Real Time and look up for OMP Peers in the search bar.</p> <p>Thanks to the previous configurations on west hubs, we have now OMP session to Controller-1 (1.1.1.3) that owns WEST-REGION (1), Controller-3 (1.1.1.5) that owns the Core Region (0)  and the default/flat Controller-4 (1.1.1.6) being used for Migration.</p> <p></p> <p>Also, take a look to any of the East Border devices like BR-EAST-1 and you will see a similar OMP peering with the exception of the  Controller-2 (1.1.1.4) that serves the EAST-REGION (2)</p> <p></p> <p>Now modify the Centralized Control Policy to allow the Border routers, to receive the Private1 TLOCs of each other and therefore, to create a fabric on the Core Region.</p> <p>Hence, go to Configuration &gt; Policies and activate the pre-configured OMP_CORE_TLOCS_POLICY Centralized Policy.</p> <p></p> <p>Click \u2018Activate\u2019.</p> <p>Note</p> <p>Analyze this Centralized Policy we just activated, where we now advertise the Core Private1 TLOCs to the between the Border routers, besides its respective Regional Hub &amp; Spoke logic.</p>"},{"location":"task5/","title":"Task 5 - Enable Region on Edge Routers","text":"<p>To add from word document task 10 </p> <p>In this task you will make the West and East routers Region-Aware</p>"},{"location":"task5/#step-1-enable-region-on-west-edge-devices","title":"Step 1: Enable Region on West Edge devices","text":"<p>Go to Configuration &gt; Templates &gt; Feature templates and look up for the cEDGE_EDGE-WEST_SYSTEM_FT feature template we created in task 3 and edit it.</p> <p></p> <p>Make Global on the \u2018Region\u2019 parameter to assign all devices attached to this feature template to the WEST-REGION. This will cause all devices in the West region to peer to the Controller-1 (1.1.1.3) that owns WEST-REGION (1), keeping the peering with the default/flat Controller-4 (1.1.1.6) being used for Migration.</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019.</p> <p></p> <p>Finally, click \u2018Configure Devices\u2019 to apply this change to all devices in the West Region. </p>"},{"location":"task5/#step-2-enable-region-on-east-edge-devices","title":"Step 2: Enable Region on East Edge devices","text":"<p>Now, let\u2019s repeat the same process but now for the East Edge devices, therefore, go to Configuration &gt; Templates &gt; Feature templates and look up for the cEDGE_EDGE-EAST_SYSTEM_FT feature template and edit it.</p> <p></p> <p>Again, make Global on the \u2018Region\u2019 parameter to assign all devices attached to this feature template to the EAST-REGION. This will cause all devices in the West region to peer to the Controller-1 (1.1.1.4) that owns EAST-REGION (2), keeping the peering with the default/flat Controller-4 (1.1.1.6) being used for Migration.</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019.</p> <p></p> <p>Finally click \u2018Configure Devices\u2019 to apply this change to all devices in the East Region. </p>"},{"location":"task6/","title":"Task 6 - MRF Migration Clean Up","text":"<p>Now that you have all Edge and Border peered with regional controllers, and completed the MRF migration. In this task you will clean up the temporary policy and migration mode.  </p>"},{"location":"task6/#step-1-remove-route-map","title":"Step 1: Remove route-map","text":"<p>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_HUB_VPN-10_BGP_FT and edit to remove route-map you completed in task 4.  </p> <p> </p> <p>Under UNICAST ADDRESS FAMILY, click pencil to edit the OMP redistribution policy.  </p> <p> </p> <p>Remove associated the route policy by changing it to default, and Save Changes </p> <p> </p> <p>Under NEIGHBOR section, click pencil to edit the policy associate the BGP neighbor.  </p> <p> </p> <p>Remove associated outbound route policy by changing Route Policy Out to Off.  </p> <p> </p> <p>Click Save Changes then Update to trigger the configuration change. Click Configure Devices to remove the loop prevention BGP route policy you applied on task 4 on all 4 Border Routers.  </p>"},{"location":"task6/#step-2-disable-migration-mode","title":"Step 2: Disable Migration Mode","text":"<p>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_BORDER-WEST-201_SYSTEM_FT and edit it.  </p> <p> </p> <p>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the West Border router will keepthe OMP session to West Region aware controller-1 (1.1.1.3), and the Core region Controller-3 (1.1.1.5), but will remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </p> <p> </p> <p>Click Update, then Next and thenn Configure Devices to disable the migration mode on both West Border routers.</p> <p>Repeat the same process to disable Migration Mode for East Border routers.</p> <p>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_BORDER-EAST-202_SYSTEM_FT and edit it.  </p> <p> </p> <p>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the East Border router will keepthe OMP session to West Region aware controller-2 (1.1.1.4), and the Core region Controller-3 (1.1.1.5), but will remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </p> <p> </p> <p>Click Update, then Next and thenn Configure Devices to disable the migration mode on both East Border routers.</p> <p>Repeat the same process to disable Migration Mode for West Edge routers.  </p> <p>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_EDGE-WEST_SYSTEM_FT and edit it.  </p> <p> </p> <p>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the West Region Edge devices will keep the OMP session to West Region aware controller-1 (1.1.1.3), and remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </p> <p> </p> <p>Click Update, then Next and thenn Configure Devices to disable the migration mode on all West Edge routers.   </p> <p>Repeat the same process to disable Migration Mode for East Edge routers.  </p> <p>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_EDGE-EAST_SYSTEM_FT and edit it.  </p> <p> </p> <p>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the East Region Edge devices will keep the OMP session to West Region aware controller-2 (1.1.1.4), and remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </p> <p> </p> <p>Click Update, then Next and thenn Configure Devices to disable the migration mode on all East Edge routers.  </p>"},{"location":"task6/#step-3-re-purpose-default-controller","title":"Step 3: Re-purpose default controller","text":"<p>After disable migration mode on all border and Edge devices, the default/flat overlay Controller-4 (1.1.1.6) is no longer peering with any device. In this step, you will re-purpose reposition this controller to the Core region for redundancy. Note: This is optional task </p> <ul> <li>Go to Configuration &gt; Templates &gt; Device Templates, look up for the device template of controller for core region CONTROLLER-3_DT and Attach Devices.  </li> </ul> <p> </p> <ul> <li>Select Controller-4 from Available Devices window move it to Selected Devices window, then click 'Attach' and then 'Next'. </li> </ul> <p> </p> <ul> <li>Configure Devices to push the configuration. This moves Controller-4 to Core region.  </li> </ul> <p> </p>"},{"location":"task6/#step-4-de-active-current-centralized-policy","title":"Step 4: De-active current Centralized Policy","text":"<p>As MRF by default makes inte-region connections via core region, the centralized policy configured in flat fabric becomes unnecessary. Let's deactive the current centralized policy and remove the BGP core between borders.  </p> <p> Note: In this lab, no service in the core region hence you will remove the service VPN and BGP in core region. </p> <p>Go to Configuration &gt; Policies and deactivate the current active Centralized Policy OMP_CORE_TLOCS_POLICY </p> <p>Click Deactivate and Deactivate once again.  </p> <p> </p> <p>Shutdown on all Hubs the service VPN 10 interfaces that were used for the BGP core, this will cause now to use the Fabric we created at the Core with the Private1 TLOCs, therefore go to Configuration &gt; Templates &gt; Device Templates and look up for cEDGE_SITE-201_DT device template and now click on Change Device Values.  </p> <p> </p> <p>Scroll to the right and mark the checkbox or click on the three dots to shut down the VPN-10_CHILD_IF-1 interfaces on both Border Routers BR-WEST-1 and BR-WEST-2.  </p> <p>Click Next and then Configure Devices.  </p> <p> </p> <p>  Note: Repeat the same process for cEDGE_SITE-202_DT Device Template to shutdown VPN 10 interfaces on BR-EAST-1 and BR-EAST-2.  </p> <p>Now, Let's verify the connectivity between Site 3000 and Site 6000 from Ubuntu VM and check the path from traceroute.  </p> <p>Open mRemoteNG RDP to host Site-3000-VPN-10-Ubun. Ping and trace the Ubuntu host located in Site 6000 with IP 10.60.1.101 </p> <p>As we can see below, both are still reachable and the traffic is still going through the Fabric we created in the Core, but now without a such complex Control Policy.  </p> <p> </p> <p># Congratulations, you have fully migrated your overlay from a Regional Hub &amp; Spoke using Control Policy to a Multi-Region Fabric without Control Policy.</p>"},{"location":"task7/","title":"Task 7 - Create a MRF Secondary Region","text":"<p>The Secondary Region is a feature within Multi-Region Fabric that provides a direct path between sites in different regions. Depending on the requirements, this path over 2nd region can serve as primary path between sites in different regions, or backup path or ECMP.  </p> <p>In this task you will create a Secondary Region between the West Site 5000 and the East Sites 6000 and 7000 as shown in the diagram below.</p> <p> </p> <p>First, RDP into the Ubuntu Site-5000-VPN-10-Ubun host in Site 5000 using the mRemoteNG client and the ping and trace the IP 10.60.1.101* that lives in Site 6000**.</p> <p> </p> <p>As you can see, it is reachable through the Fabric in the Core now.</p>"},{"location":"task7/#step-1-create-secondary-region","title":"Step 1: Create Secondary Region","text":"<p>Create the Secondary Region, therefore go to Configuration &gt; Network Hierarchy and in Global click on the 3 dots and select \u2018Add Node\u2019.</p> <p> </p> <p>Select the \u2018Region\u2019 Type and name it as SECONDARY-REGION</p> <p> </p> <p>Click \u2018Add\u2019.</p> <p> Note. As with the primary West and East Region, now this Secondary region has been assigned with the Region ID 3 automatically by the system </p>"},{"location":"task7/#step-2-create-transport-interface-feature-templates-with-secondary-region","title":"Step 2: Create Transport Interface Feature Templates with Secondary Region","text":"<p>Now, go to Configuration &gt; Templates &gt; Feature and look up for the existing cEDGE_SITE-ALL_VPN-0_PUB-INET_IF_FT feature template and click 'Copy' to clone it.</p> <p> </p> <p>Name it as cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT and click \u2018Copy\u2019</p> <p> </p> <p>Now, look up for the template we just cloned named cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT and edit it.</p> <p> </p> <p>Next, go to the \u2018Tunnel\u2019 section and under  \u2018Advanced Options\u2019, enable \u2018Secondary Region\u2019 as Shared Between Primary and Secondary Regions and click \u2018update\u2019.</p> <p> </p> <p>Click 'Update'.</p> <p>Step 4. Again, go to Configuration &gt; Templates &gt; Feature and look up for the existing cEDGE_SITE-ALL_VPN-0_MPLS_IF_FT feature template to clone it.</p> <p> </p> <p>Name it as cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT</p> <p> </p> <p>Click \u2018Copy\u2019.</p> <p>Now, look up again for the template we just cloned named cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT and edit it.</p> <p> </p> <p>First, define the Interface Name as a variable (this because it will be used for Site7000 that uses a different interface for the MPLS TLOC).</p> <p> </p> <p>Next, go to the \u2018Tunnel\u2019 section and under \u2018Advanced Options\u2019, enable \u2018Secondary Region\u2019 as Shared Between Primary and Secondary Regions</p> <p> </p> <p>Click 'Update'.</p>"},{"location":"task7/#step-3-create-an-omp-feature-template-to-influenciate-the-omp-best-path-algorithm","title":"Step 3: Create an OMP Feature Template to influenciate the OMP Best Path Algorithm","text":"<p>Go to Configuration &gt; Templates &gt; Feature and let\u2019s copy now the existing cEDGE_ALL_OMP_FT feature template. </p> <p>Name it as cEDGE_OMP_PRI_AND_SEC_REGIONS_FT</p> <p></p> <p>Click \u2018Copy\u2019.</p> <p>Once created it look up for cEDGE_OMP_PRI_AND_SEC_REGIONS_FT and edit it.</p> <p></p> <p>Now go to the \u2018Best Path\u2019 section, and make Global on to enable the Ignore Region-Path Length During Best-Path Algorithm parameter, then click \u2018update\u2019. </p> <p></p> <p>Click 'Update'.</p> <p> Note: The default value is Off, and by default, OMP gives preference to a direct tunnel path over a hierarchical path because the direct path has fewer hops </p> <p> With this configuration, we disable the comparison of the number of hops, OMP applies equal-cost multi-path routing (ECMP) to all routes, and packets can use all available paths. </p>"},{"location":"task7/#step-4-create-a-system-feature-template-with-secondary-region-for-site-5000","title":"Step 4: Create a System Feature Template with Secondary Region for Site 5000","text":"<p>Let\u2019s clone the Cisco System Feature template currently used by the Site 5000 edge router to participate in the secondary. So, go Configuration &gt; Templates &gt; Feature and look up for the cEDGE_EDGE-WEST_SYSTEM_FT and click \u2018Copy\u2019</p> <p>Name it as cEDGE_PRI_AND_SEC_REGIONS-WEST_SYSTEM_FT.</p> <p></p> <p>Click \u2018Copy\u2019.</p> <p></p> <p>Look up for the cEDGE_PRI_AND_SEC_REGIONS-WEST_SYSTEM_FT feature template we just created and click \u2018Edit\u2019</p> <p></p> <p>Make Global on the \u2018Secondary Region\u2019 parameter and select SECONDARY-REGION from the dropdown menu.</p> <p></p> <p>Click \u2018Update\u2019 to save the changes.</p>"},{"location":"task7/#step-5-update-site-5000-device-template","title":"Step 5: Update Site 5000 Device Template","text":"<p>Next, go to Configuration &gt; Templates &gt; Device Templates look up for the cEDGE_SITE-5000_DT device template and edit it.</p> <p></p> <p>In the \u2018Cisco System\u2019 section, select the feature template we previously created named cEDGE_PRI_AND_SEC_REGIONS-WEST_SYSTEM_FT</p> <p></p> <p>Now, in the \u2018Cisco OMP\u2019 section, select the cEDGE_OMP_PRI_AND_SEC_REGIONS_FT feature template we created in step 3.</p> <p></p> <p>Next, in the \u2018Transport &amp; Management VPN\u2019 section, change the two Cisco VPN Interface Ethernet feature templates to the ones created in step 1 named cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT and cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT respectively.</p> <p></p> <p>Finally, click \u2018Update\u2019, and fill out the 2 missing variables with GigabitEthernet2 and 10.2.11.2/24 respectively.</p> <p></p> <p>Click \u2018Update\u2019 and you should see in the \u2018Config Diff\u2019 section all the next lines in green color being pushed to the device if you scroll down</p> <p> </p> <p>Finally click \u2018Configure Devices\u2019.</p>"},{"location":"task7/#step-6-create-a-system-feature-template-with-secondary-region-for-site-6000-and-7000","title":"Step 6: Create a System Feature Template with Secondary Region for Site 6000 and 7000","text":"<p>Again, for simplicity, let\u2019s copy the \u2018System\u2019 Feature template currently used by the Site 6000 and 7000 to participate in the secondary. So, go Configuration &gt; Templates &gt; Feature and look up for the cEDGE_EDGE-EAST_SYSTEM_FT and click \u2018Copy\u2019.</p> <p></p> <p>Name it  cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT</p> <p></p> <p>Next, look up for the same cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT feature template we just created and click \u2018Edit\u2019.</p> <p></p> <p>Next, make Global on the \u2018Secondary Region\u2019 parameter and select SECONDARY-REGION from the dropdown menu.</p> <p></p> <p>Click \u2018Update\u2019.</p>"},{"location":"task7/#step-7-update-site-6000-device-template","title":"Step 7: Update Site 6000 Device Template","text":"<p>Now in Configuration &gt; Templates &gt; Device Templates look up for the cEDGE_SITE-6000_DT device template and edit it to call all the new feature templates.</p> <p></p> <p>In \u2018Cisco System\u2019 section select the feature template we previously created named cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT.</p> <p></p> <p>Next, in the \u2018Cisco OMP\u2019 section, select the cEDGE_OMP_PRI_AND_SEC_REGIONS_FT feature template we created in step 3.</p> <p></p> <p>Now, in the \u2018Transport &amp; Management VPN\u2019 section, change the two Cisco VPN Interface Ethernet feature templates to the ones created in step 2 named cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019.</p> <p>You should see the all the next lines in green color in the \u2018Config Diff\u2019 being pushed to the device if you scroll down. Finally click \u2018Configure Devices\u2019.</p> <p> </p>"},{"location":"task7/#step-8-update-site-7000-device-template","title":"Step 8: Update Site 7000 Device Template","text":"<p>let\u2019s repeat the same process as step 7 but now for Site 7000, therefore go to Configuration &gt; Templates &gt; Device Templates look up for the cEDGE_SITE-7000_DT device template and edit it to call all the new feature templates.</p> <p></p> <p>In \u2018Cisco System\u2019 section select the cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT feature template.</p> <p></p> <p>Now, in the \u2018Cisco OMP\u2019 section, select the cEDGE_OMP_PRI_AND_SEC_REGIONS_FT feature template.</p> <p></p> <p>Next, in the \u2018Transport &amp; Management VPN\u2019 section, change the two Cisco VPN Interface Ethernet feature templates to the ones created in step 2 named cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT.</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019 and fill out the 2 missing variables with GigabitEthernet1 and 10.2.12.2/24 respectively.</p> <p></p> <p>You should see the all the next lines in green color in the \u2018Config Diff\u2019 being pushed to the device if you scroll down. Finally click \u2018Configure Devices\u2019.</p> <p> </p> <p>Finally click \u2018Configure Devices\u2019</p>"},{"location":"task7/#step-9-make-controller-3-secondary-region-aware-and-validation","title":"Step 9: Make Controller-3 Secondary Region-aware and Validation","text":"<p>The sites Site 5000, Site 6000 and Site 7000 have been configured to participate in the SECONDARY-REGION (3), the last thing to do is to configure the Controller-3 (1.1.1.5) to participate as well in this region</p> <p>Go to Configuration &gt; Templates &gt; Feature Templates and look up for the CONTROLLER-3_SYSTEM_FT feature template and edit it.</p> <p></p> <p>Next, in the \u2018Region ID List\u2019 parameter, add the SECONDARY-REGION to serve this region besides the Core Region.</p> <p></p> <p>Click \u2018Update\u2019, then \u2018Next\u2019 and you should see the next in the \u2018Config Diff\u2019.</p> <p></p> <p>Click \u2018Configure Devices\u2019.</p> <p>At this point Site 5000 has connectivity to Site 6000 and 7000 and vice versa through the Core Fabric and through the Direct Path. </p> <p>This ECMP is because we enabled \u2018Ignore Region-Path Length During Best-Path Algorithm\u2019. This is particularly useful on some use-cases where we want to Send non-critical traffic using cheaper WAN links rather than using the optimized middle-mile WAN or PAYG links. </p> <p>We can confirm this only through the CLI, hence go to the mRemoteNG client and SSH into the EDGE-BRANCH-5-01 and then issue the command show ip route vrf 10.</p> <p></p> <p>As we can see from on from the previous output, all prefixes from the East Region have now 3 TLOCs IP pointing to, two being through the West Border routers, and one being the Originator TLOC IP for the direct path.</p> <p>Finally, go back to the Ubuntu Site-5000-VPN-10-Ubun host, and run another trace to the 10.60.1.101 that lives in Site 6000</p> <p></p> <p>This time we can see that this flow goes through the Core, however because the ECMP hash, it could go as well through the direct path.</p>"},{"location":"task8/","title":"Task 8 - MRF Policy","text":"<p>In this task you will create a Multi-Region Fabric (MRF) Control Policy that will steer VPN 11 traffic through the direct path over the Secondary Region while all other VPN 10 traffic will ECMP through all paths.</p>"},{"location":"task8/#step-1-create-a-new-control-policy","title":"Step 1: Create a New Control Policy","text":"<p>Go to Configuration &gt; Policies &gt; Add Policy</p> <p></p> <p>On the left-side pane from the first section, select Region and then click \u2018New Region List\u2019</p> <p></p> <p>Name this Region List as ACCESS with the regions 1,2.</p> <p></p> <p>Click \u2018Add\u2019.</p> <p>Also, let\u2019s create a Site List, so click on the left-side pane \u2018Site\u2019 and then \u2018+New Site List\u2019.</p> <p></p> <p>Name it as SECONDARY_REGION_SITES with the Sites 5000,6000,7000</p> <p></p> <p>Click \u2018Add\u2019 and then \u2018Next\u2019. </p> <p>Now, click Add Topology and select Custom Control (Route &amp; Tloc)</p> <p></p> <p>Name this Control Policy as MRF_CP.</p> <p></p> <p>Click \u2018+ Sequence Type\u2019 and then select \u2018TLOC\u2019</p> <p></p> <p>Next, click on \u2018+ Sequence Rule\u2019, and select \u2018Actions\u2019 and finally enable \u2018Accept\u2019</p> <p></p> <p>Click \u2018Save Match and Actions\u2019.</p> <p>Now, again click \u2018+ Sequence Type\u2019, but this time select \u2018Route\u2019</p> <p></p> <p>Click on \u2018+ Sequence Rule\u2019, and under the \u2018Match\u2019 section, select \u2018Region\u2019 with the Region List ACCESS</p> <p></p> <p>Also, add a match for \u2018VPN\u2019 for VPN ID 11</p> <p></p> <p>Next, add one more match for \u2018Path Type\u2019 and select HIERARCHICAL</p> <p></p> <p>Now click \u2018Actions\u2019 and leave the \u2018Reject\u2019 option enabled.</p> <p></p> <p>Click 'Save Match and Actions'</p> <p>Click again on \u2018+ Sequence Rule\u2019, and do not select any match.</p> <p></p> <p>Next, click \u2018Actions, and enable \u2018Accept\u2019.</p> <p></p> <p>Click \u2018Save Match and Actions\u2019.</p> <p>Finally, click \u2018Save Control Policy\u2019.</p> <p>You will be returned to the next \u2018Configure Topology and VPN Membership\u2019 where now we can see the Control Policy we just created.</p> <p></p> <p>Click \u2018Next\u2019, and \u2018Next\u2019 once again till you get to the \u2018Apply Policies to Sites and VPNs\u2019 section.</p> <p>Name, this Centralized Policy as MRF_POLICY, then click \u2018+ New Site/Region List\u2019 and enable \u2018Region\u2019 with ACCESS as the Outbound Region List as follows.</p> <p></p> <p>Click 'Add'.</p> <p></p> <p>Finally click \u2018Save Policy\u2019.</p>"},{"location":"task8/#step-2-understand-activate-and-confirm-mrf-policy","title":"Step 2: Understand, Activate and Confirm MRF Policy","text":"<p>Before we activate this new MRF Policy, go to Configuration &gt; Policies and click \u2018Preview\u2019 on the MRF_POLICY policy we just created</p> <p></p> <p>Try to understand such policy first, but at the end, what we are doing with the MRF Control Policy is to not advertise prefixes from Access regions 1 and 2 with a hierarchical path and from VPN 11 to Sites 5000, 6000 and 7000 only.</p> <p></p> <p>This a good use-case example, where we do want VPN 10, where we have our critical Corporate traffic, to go through the Core or the direct Path with ECMP, while only allowing our Guest Traffic in VPN 11 to go through the direct path on only these sites with Secondary Regions, without affecting the rest of the access sites. This with the intent to reduce costs and bandwidth at the Core.</p> <p>Activate the Policy the MRF_POLICY we just created.</p> <p></p> <p>Click \u2018Activate\u2019 and \u2018Activate\u2019 once again.</p> <p>Now, SSH into EDGE-BRANCH-5-01 and issue the show command show ip route vrf 10.</p> <p></p> <p>As we can see on the output above, we do have all prefixes from the East Region using all paths available for ECMP, being through the Core or through the Direct Path.</p> <p>Now, run the show command show ip route vrf 11</p> <p></p> <p>Above we see now, that for VPN 11 we can only communicate to the East Region using the direct path as defined in the MRF Policy.</p> <p>We can confirm the same by running a trace from the Site-5000-VPN-10-Ubun Ubuntu host to the 10.60.1.101 that lives in Site 6000 in service VPN 10</p> <p></p> <p>This time, because the ECMP hash, the traffic is going through the Core but it may go through the Direct Path as well.</p> <p>Finally, let\u2019s repeat the same tests but now from the Site-5000-VPN-11-Ubun Ubuntu host to the 10.61.1.101 that lives in Site 6000 in service VPN 11.</p> <p></p>"},{"location":"topology/","title":"Lab Topology","text":"<p>Network topology used in this lab are shown in below picture:  </p> <ul> <li>Regional Hub &amp; Spoke with BGP core  </li> </ul> <p> </p> <ul> <li>Multi-Region (MRF) SD-WAN Fanric  </li> </ul> <p> </p>"}]}